name: Test Web Build

on:
  pull_request:
    paths:
      - 'web/**'
      - 'src/wormgear/**'
      - '.github/workflows/test-web-build.yml'
      - 'tests/test_web_build.py'
  push:
    branches:
      - main
    paths:
      - 'web/**'
      - 'src/wormgear/**'

jobs:
  test-web-build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest

    - name: Make build script executable
      run: chmod +x web/build.sh

    - name: Run web build tests
      run: pytest tests/test_web_build.py -v

    - name: Verify build output exists
      run: |
        if [ ! -d "web/wormgear" ]; then
          echo "ERROR: web/wormgear directory not created by build"
          exit 1
        fi

        echo "✅ Build output verified"
        ls -la web/wormgear/

    - name: Check for missing files
      run: |
        cd web

        # List of critical files that MUST exist (calculator + io modules)
        CRITICAL_FILES=(
          "wormgear/__init__.py"
          "wormgear/calculator/__init__.py"
          "wormgear/calculator/core.py"
          "wormgear/calculator/validation.py"
          "wormgear/calculator/output.py"
          "wormgear/calculator/js_bridge.py"
          "wormgear/calculator/json_schema.py"
          "wormgear/io/__init__.py"
          "wormgear/io/loaders.py"
          "wormgear/io/schema.py"
        )

        ALL_OK=true
        for file in "${CRITICAL_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ MISSING: $file"
            ALL_OK=false
          else
            echo "✅ Found: $file"
          fi
        done

        if [ "$ALL_OK" = false ]; then
          echo ""
          echo "ERROR: Some critical files are missing from web build output!"
          exit 1
        fi

        echo ""
        echo "✅ All critical files present"
