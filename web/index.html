<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worm Gear 3D Generator - Web Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .status-panel {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .status-panel.loading {
            border-color: #ffc107;
        }

        .status-panel.success {
            border-color: #28a745;
        }

        .status-panel.error {
            border-color: #dc3545;
        }

        .status-text {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .status-detail {
            font-size: 0.9em;
            color: #666;
            font-family: 'Courier New', monospace;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .json-input-area {
            position: relative;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }

        .control-group input,
        .control-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .console-line {
            margin-bottom: 5px;
        }

        .console-line.info {
            color: #4fc3f7;
        }

        .console-line.success {
            color: #81c784;
        }

        .console-line.error {
            color: #e57373;
        }

        .console-line.warning {
            color: #ffb74d;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .viewer-container {
            width: 100%;
            height: 500px;
            background: #f0f0f0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 1.1em;
        }

        .file-drop-zone {
            border: 3px dashed #ddd;
            border-radius: 6px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .file-drop-zone:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .file-drop-zone.drag-over {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .sample-designs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .sample-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sample-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî© Worm Gear 3D Generator</h1>
            <p>Browser-based CAD generation using Pyodide & build123d</p>
        </div>

        <div class="content">
            <!-- Status Panel -->
            <div id="statusPanel" class="status-panel loading">
                <div class="status-text">
                    <span class="spinner"></span>
                    <span id="statusText">Initializing Pyodide...</span>
                </div>
                <div class="status-detail" id="statusDetail">Loading Python runtime...</div>
            </div>

            <!-- JSON Input Section -->
            <div class="section">
                <h2>1. Load Design JSON</h2>

                <div class="sample-designs">
                    <button class="sample-btn" onclick="loadSampleDesign('sample_m2_ratio30')">Sample M2 Ratio 30:1</button>
                    <button class="sample-btn" onclick="loadSampleDesign('7mm')">7mm Design</button>
                </div>

                <div class="file-drop-zone" id="dropZone">
                    <div>üìÅ Drop JSON file here or click to browse</div>
                    <input type="file" id="fileInput" accept=".json" style="display: none;">
                </div>

                <div class="json-input-area">
                    <textarea id="jsonInput" placeholder="Paste your design JSON from wormgearcalc here..."></textarea>
                </div>
            </div>

            <!-- Parameter Controls -->
            <div class="section">
                <h2>2. Generation Parameters</h2>

                <div class="controls">
                    <div class="control-group">
                        <label>Worm Length (mm)</label>
                        <input type="number" id="wormLength" value="40" min="10" max="200" step="5">
                    </div>

                    <div class="control-group">
                        <label>Wheel Width (mm)</label>
                        <input type="number" id="wheelWidth" value="" placeholder="Auto">
                    </div>

                    <div class="control-group">
                        <label>Wheel Type</label>
                        <select id="wheelType">
                            <option value="helical">Helical (Default)</option>
                            <option value="hobbed">Hobbed (Throated)</option>
                        </select>
                    </div>
                </div>

                <div class="controls">
                    <div class="checkbox-group">
                        <input type="checkbox" id="addBore">
                        <label for="addBore">Add Bore</label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="addKeyway">
                        <label for="addKeyway">Add Keyway (DIN 6885)</label>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="section">
                <h2>3. Generate Geometry</h2>

                <div class="button-group">
                    <button id="generateBtn" onclick="generateGeometry()" disabled>
                        Generate STEP Files
                    </button>
                    <button id="testBtn" onclick="testBuild123d()" disabled>
                        Test build123d
                    </button>
                </div>
            </div>

            <!-- Console Output -->
            <div class="section">
                <h2>Console Output</h2>
                <div class="console" id="console">
                    <div class="console-line info">Waiting for initialization...</div>
                </div>
            </div>

            <!-- 3D Viewer (placeholder for now) -->
            <div class="section hidden" id="viewerSection">
                <h2>3D Preview</h2>
                <div class="viewer-container">
                    3D Viewer (Coming Soon)
                </div>
            </div>
        </div>
    </div>

    <!-- Load Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>

    <script>
        let pyodide = null;
        let consoleLines = [];

        // Console logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            consoleLines.push({ time: timestamp, message, type });
            updateConsole();
        }

        function updateConsole() {
            const console = document.getElementById('console');
            console.innerHTML = consoleLines.map(line =>
                `<div class="console-line ${line.type}">[${line.time}] ${line.message}</div>`
            ).join('');
            console.scrollTop = console.scrollHeight;
        }

        // Status panel updates
        function updateStatus(text, detail, state = 'loading') {
            const panel = document.getElementById('statusPanel');
            const statusText = document.getElementById('statusText');
            const statusDetail = document.getElementById('statusDetail');

            panel.className = `status-panel ${state}`;

            if (state === 'loading') {
                statusText.innerHTML = `<span class="spinner"></span><span>${text}</span>`;
            } else {
                const icon = state === 'success' ? '‚úì' : state === 'error' ? '‚úó' : '‚Ñπ';
                statusText.innerHTML = `<span>${icon} ${text}</span>`;
            }

            statusDetail.textContent = detail;
        }

        // Initialize Pyodide
        async function initPyodide() {
            try {
                log('Loading Pyodide...');
                updateStatus('Loading Pyodide...', 'Downloading Python runtime', 'loading');

                pyodide = await loadPyodide({
                    indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.29.0/full/'
                });

                log('Pyodide loaded successfully', 'success');
                updateStatus('Pyodide Ready', 'Python runtime loaded', 'success');

                // Install micropip
                log('Installing micropip...');
                await pyodide.loadPackage('micropip');
                const micropip = pyodide.pyimport('micropip');

                log('micropip ready', 'success');

                // Now try to install build123d
                await installBuild123d(micropip);

            } catch (error) {
                log(`Error initializing Pyodide: ${error.message}`, 'error');
                updateStatus('Initialization Failed', error.message, 'error');
                console.error('Pyodide init error:', error);
            }
        }

        // Install build123d and dependencies
        async function installBuild123d(micropip) {
            try {
                // Use Jojain's approach from build123d-sandbox
                // https://github.com/Jojain/build123d-sandbox
                updateStatus('Installing CAD packages...', 'Following Jojain\'s working method', 'loading');
                log('üì¶ Using proven installation method from build123d-sandbox');
                log('‚è≥ Large download - please be patient (2-5 minutes)...', 'info');

                const result = await pyodide.runPythonAsync(`
import micropip

print("Starting package installation...")
print("Setting index URLs...")
micropip.set_index_urls(["https://yeicor.github.io/OCP.wasm", "https://pypi.org/simple"])
print("Index URLs set")

print("Installing lib3mf...")
await micropip.install("lib3mf")
print("‚úì lib3mf installed")

print("Installing ssl...")
await micropip.install("ssl")
print("‚úì ssl installed")

print("Installing ocp_vscode from Jojain's fork...")
await micropip.install("https://raw.githubusercontent.com/Jojain/vscode-ocp-cad-viewer/no_pyperclip/ocp_vscode-2.9.0-py3-none-any.whl")
print("‚úì ocp_vscode installed")

# Mock package for build123d<0.10.0 compatibility
micropip.add_mock_package("py-lib3mf", "2.4.1", modules={"py_lib3mf": '''from lib3mf import *'''})
print("‚úì Mock package added")

print("Installing build123d and sqlite3...")
await micropip.install(["build123d", "sqlite3"])
print("‚úì Installation completed")

# Test imports
print("Testing imports...")
try:
    import build123d
    print(f"‚úì build123d imported (version: {getattr(build123d, '__version__', 'unknown')})")
    success = True
except ImportError as e:
    print(f"‚úó build123d import failed: {e}")
    success = False

"SUCCESS" if success else "FAILED"
                `);

                if (result === 'SUCCESS') {
                    log('‚úì All packages installed successfully!', 'success');
                    log('‚úì build123d is ready to use', 'success');
                    updateStatus('Ready to Generate', 'build123d loaded and tested', 'success');

                    document.getElementById('generateBtn').disabled = false;
                    document.getElementById('testBtn').disabled = false;

                    log('System ready - click "Test build123d" to verify geometry creation', 'info');
                } else {
                    log('‚ö† Packages installed but import test failed', 'warning');
                    log('Click "Test build123d" to see detailed error', 'info');
                    updateStatus('Partially Ready', 'Packages installed, imports may fail', 'warning');

                    document.getElementById('testBtn').disabled = false;
                }

            } catch (error) {
                log(`‚úó Installation failed`, 'error');
                log(`Error: ${error.message}`, 'error');

                // Show traceback
                try {
                    const tb = await pyodide.runPythonAsync('import traceback; traceback.format_exc()');
                    log('Python traceback:', 'error');
                    tb.split('\\n').forEach(line => line && log(line, 'error'));
                } catch (e) {}

                updateStatus('Installation Failed',
                    'Could not install CAD packages', 'error');
                console.error('Installation error:', error);

                document.getElementById('testBtn').disabled = false;

                log('', 'info');
                log('üìù Troubleshooting:', 'warning');
                log('‚Ä¢ Check browser console for detailed errors', 'info');
                log('‚Ä¢ Try using the Python library locally instead (recommended)', 'info');
                log('‚Ä¢ See web/CURRENT_STATUS.md for known issues', 'info');
            }
        }

        // Test build123d import
        async function testBuild123d() {
            if (!pyodide) {
                log('Pyodide not initialized yet', 'error');
                return;
            }

            try {
                log('Testing build123d and OCP...');
                log('This may take a moment...', 'info');

                const result = await pyodide.runPythonAsync(`
import sys

output = []

# Test OCP import
try:
    import OCP
    output.append("‚úì OCP imported successfully")
    ocp_ok = True
except ImportError as e:
    output.append(f"‚úó OCP import failed: {e}")
    ocp_ok = False

# Test build123d import
try:
    import build123d
    output.append(f"‚úì build123d imported (version: {getattr(build123d, '__version__', 'unknown')})")
    b3d_ok = True
except ImportError as e:
    output.append(f"‚úó build123d import failed: {e}")
    b3d_ok = False

# If both work, try to create a simple object
if ocp_ok and b3d_ok:
    try:
        from build123d import Box, Cylinder
        box = Box(10, 10, 10)
        cyl = Cylinder(5, 20)
        output.append(f"‚úì Created test box (volume: {box.volume:.2f} mm¬≥)")
        output.append(f"‚úì Created test cylinder (volume: {cyl.volume:.2f} mm¬≥)")
        result = "SUCCESS"
    except Exception as e:
        output.append(f"‚úó Geometry creation failed: {e}")
        result = "PARTIAL"
else:
    result = "FAILED"

"\\n".join(output) + "\\n" + result
                `);

                if (!result) {
                    log('Test returned no result', 'error');
                    return;
                }

                const lines = result.split('\n');
                for (const line of lines) {
                    if (line.includes('‚úì')) {
                        log(line, 'success');
                    } else if (line.includes('‚úó')) {
                        log(line, 'error');
                    } else if (line === 'SUCCESS' || line === 'PARTIAL' || line === 'FAILED') {
                        // Skip these, we'll handle them below
                    } else if (line.trim()) {
                        log(line, 'info');
                    }
                }

                if (result.includes('SUCCESS')) {
                    log('‚úì All tests passed! Ready to generate worm gears', 'success');
                } else if (result.includes('PARTIAL')) {
                    log('‚ö† Partial success - some features may not work', 'warning');
                } else {
                    log('‚úó Tests failed - installation incomplete', 'error');
                }

            } catch (error) {
                log(`Test error: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        }

        // File handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const jsonInput = document.getElementById('jsonInput');

        dropZone.onclick = () => fileInput.click();

        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        };

        dropZone.ondragleave = () => {
            dropZone.classList.remove('drag-over');
        };

        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) loadFile(file);
        };

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) loadFile(file);
        };

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                jsonInput.value = e.target.result;
                log(`Loaded file: ${file.name}`, 'success');
                try {
                    const data = JSON.parse(e.target.result);

                    // Validate structure
                    if (!data.design) {
                        log('‚ö† Warning: JSON missing "design" object', 'warning');
                        log('Expected format: { "design": { "worm": {...}, "wheel": {...}, "assembly": {...} } }', 'info');
                    } else if (!data.design.worm || !data.design.wheel || !data.design.assembly) {
                        log('‚ö† Warning: Incomplete design structure', 'warning');
                        if (!data.design.worm) log('  Missing: design.worm', 'warning');
                        if (!data.design.wheel) log('  Missing: design.wheel', 'warning');
                        if (!data.design.assembly) log('  Missing: design.assembly', 'warning');
                    } else {
                        log('‚úì JSON validated successfully', 'success');
                        log(`  Module: ${data.design.worm.module_mm} mm, Ratio: ${data.design.assembly.ratio}:1`, 'info');
                    }
                } catch (error) {
                    log(`‚úó Invalid JSON: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Load sample designs
        async function loadSampleDesign(name) {
            try {
                log(`Loading sample design: ${name}...`);

                // Try both paths (for local dev and deployed versions)
                let json = null;
                let loaded = false;

                // Try deployed path first (examples/ relative to index.html)
                try {
                    const response = await fetch(`examples/${name}.json`);
                    if (response.ok) {
                        json = await response.json();
                        loaded = true;
                    }
                } catch (e) {
                    // Fallback to local dev path
                    try {
                        const response = await fetch(`../examples/${name}.json`);
                        if (response.ok) {
                            json = await response.json();
                            loaded = true;
                        }
                    } catch (e2) {
                        // Will be caught below
                    }
                }

                if (loaded && json) {
                    jsonInput.value = JSON.stringify(json, null, 2);
                    log(`‚úì Loaded ${name} design`, 'success');
                } else {
                    log(`Could not load ${name}.json - file not found`, 'error');
                }
            } catch (error) {
                log(`Error loading sample: ${error.message}`, 'error');
            }
        }

        // Load wormgear_geometry package into Pyodide
        async function loadWormGearPackage() {
            try {
                log('Loading wormgear_geometry package...', 'info');

                // Create package directory and load source files
                await pyodide.runPythonAsync(`
import os
import sys
os.makedirs('/home/pyodide/wormgear_geometry', exist_ok=True)
if '/home/pyodide' not in sys.path:
    sys.path.insert(0, '/home/pyodide')
                `);

                // Fetch and load package files
                const packageFiles = ['__init__.py', 'io.py', 'worm.py', 'wheel.py', 'features.py'];
                let loadedCount = 0;

                for (const filename of packageFiles) {
                    let content = null;
                    let loadedFrom = null;

                    // Try GitHub Pages/deployed path first (src/ relative to index.html)
                    try {
                        const response = await fetch(`src/wormgear_geometry/${filename}`);
                        if (response.ok) {
                            content = await response.text();
                            loadedFrom = 'src/';
                        }
                    } catch (e) {
                        // Try local dev path (../src/ when serving from project root)
                        try {
                            const response = await fetch(`../src/wormgear_geometry/${filename}`);
                            if (response.ok) {
                                content = await response.text();
                                loadedFrom = '../src/';
                            }
                        } catch (e2) {
                            console.error(`Failed to fetch ${filename}:`, e, e2);
                        }
                    }

                    if (content) {
                        pyodide.FS.writeFile(`/home/pyodide/wormgear_geometry/${filename}`, content);
                        log(`  ‚úì Loaded ${filename} (from ${loadedFrom})`, 'success');
                        loadedCount++;
                    } else {
                        log(`  ‚úó Failed to load ${filename} from both paths`, 'error');
                    }
                }

                if (loadedCount < packageFiles.length) {
                    log(`Warning: Only loaded ${loadedCount}/${packageFiles.length} files`, 'warning');
                }

                // Test import
                await pyodide.runPythonAsync(`
import wormgear_geometry
print(f"wormgear_geometry loaded (version {wormgear_geometry.__version__})")
                `);

                log('‚úì wormgear_geometry package ready', 'success');
                return true;
            } catch (error) {
                log(`‚úó Failed to load wormgear_geometry: ${error.message}`, 'error');
                console.error('Package loading error:', error);
                return false;
            }
        }

        // Generate geometry
        async function generateGeometry() {
            if (!pyodide) {
                log('Pyodide not initialized', 'error');
                return;
            }

            const startTime = Date.now();

            try {
                const jsonText = document.getElementById('jsonInput').value;
                if (!jsonText) {
                    log('Please provide design JSON', 'error');
                    return;
                }

                const designData = JSON.parse(jsonText);
                log('‚úì JSON parsed successfully', 'success');

                // Validate structure
                if (!designData.design || !designData.design.worm || !designData.design.wheel || !designData.design.assembly) {
                    log('‚úó Invalid JSON structure', 'error');
                    log('Expected format: { "design": { "worm": {...}, "wheel": {...}, "assembly": {...} } }', 'error');
                    log('See examples/sample_m2_ratio30.json for correct format', 'info');
                    return;
                }

                // Extract parameters from UI
                const wormLength = parseFloat(document.getElementById('wormLength').value) || 40;
                const wheelWidthInput = document.getElementById('wheelWidth').value;
                const wheelWidth = wheelWidthInput ? parseFloat(wheelWidthInput) : null;
                const throated = document.getElementById('wheelType').value === 'hobbed';

                log('Starting geometry generation...', 'info');
                log(`Parameters:`, 'info');
                log(`  Module: ${designData.design.worm.module_mm} mm`, 'info');
                log(`  Ratio: ${designData.design.assembly.ratio}:1`, 'info');
                log(`  Worm length: ${wormLength} mm`, 'info');
                log(`  Wheel width: ${wheelWidth || 'auto'} mm`, 'info');
                log(`  Wheel type: ${throated ? 'hobbed (throated)' : 'helical'}`, 'info');
                log('', 'info');

                // Load package if not already loaded
                log('‚è≥ Step 1/4: Checking package...', 'info');
                const packageLoaded = await loadWormGearPackage();
                if (!packageLoaded) {
                    log('Cannot proceed - package loading failed', 'error');
                    return;
                }
                log('‚úì Package ready', 'success');
                log('', 'info');

                // Pass data to Python and generate
                log('‚è≥ Step 2/4: Preparing Python environment...', 'info');
                pyodide.globals.set('design_json_str', JSON.stringify(designData));
                pyodide.globals.set('worm_length', wormLength);
                pyodide.globals.set('wheel_width_val', wheelWidth);
                pyodide.globals.set('throated_val', throated);
                log('‚úì Parameters passed to Python', 'success');
                log('', 'info');

                updateStatus('Generating geometry...', 'This may take 30-60 seconds', 'loading');
                log('‚è≥ Step 3/4: Generating 3D geometry (please wait)...', 'info');
                log('  This may take 30-90 seconds on mobile devices', 'info');

                const pythonStartTime = Date.now();
                const result = await pyodide.runPythonAsync(`
import json
from io import BytesIO
import base64
from wormgear_geometry import WormGeometry, WheelGeometry
from wormgear_geometry import WormParams, WheelParams, AssemblyParams

print("üìã Parsing parameters...")
# Parse design JSON
design_data = json.loads(design_json_str)
design = design_data['design']

# Create parameter objects
worm_params = WormParams(**design['worm'])
wheel_params = WheelParams(**design['wheel'])
assembly_params = AssemblyParams(**design['assembly'])
print("‚úì Parameters parsed")

print("")
print("üî© Generating worm gear...")
worm_b64 = None
try:
    # Generate worm
    print("  Creating worm geometry object...")
    worm_geo = WormGeometry(
        params=worm_params,
        assembly_params=assembly_params,
        length=worm_length,
        sections_per_turn=36
    )
    print("  Building 3D model...")
    worm = worm_geo.build()
    print("  Exporting to STEP format...")

    # Export to bytes
    worm_buffer = BytesIO()
    worm_geo.export_step(worm_buffer)
    worm_step = worm_buffer.getvalue()
    worm_b64 = base64.b64encode(worm_step).decode('utf-8')

    size_kb = len(worm_step) / 1024
    print(f"‚úì Worm generated successfully!")
    print(f"  File size: {size_kb:.1f} KB ({len(worm_step)} bytes)")
except Exception as e:
    print(f"‚úó Worm generation failed: {e}")
    import traceback
    traceback.print_exc()

print("")
print("‚öôÔ∏è  Generating wheel gear...")
wheel_b64 = None
try:
    # Generate wheel
    print("  Creating wheel geometry object...")
    wheel_geo = WheelGeometry(
        params=wheel_params,
        worm_params=worm_params,
        assembly_params=assembly_params,
        face_width=wheel_width_val,
        throated=throated_val
    )
    print("  Building 3D model (this is the slowest step)...")
    wheel = wheel_geo.build()
    print("  Exporting to STEP format...")

    # Export to bytes
    wheel_buffer = BytesIO()
    wheel_geo.export_step(wheel_buffer)
    wheel_step = wheel_buffer.getvalue()
    wheel_b64 = base64.b64encode(wheel_step).decode('utf-8')

    size_kb = len(wheel_step) / 1024
    print(f"‚úì Wheel generated successfully!")
    print(f"  File size: {size_kb:.1f} KB ({len(wheel_step)} bytes)")
except Exception as e:
    print(f"‚úó Wheel generation failed: {e}")
    import traceback
    traceback.print_exc()

print("")
if worm_b64 and wheel_b64:
    print("‚úÖ Both parts generated successfully!")
elif worm_b64:
    print("‚ö†Ô∏è  Only worm generated (wheel failed)")
elif wheel_b64:
    print("‚ö†Ô∏è  Only wheel generated (worm failed)")
else:
    print("‚ùå Both parts failed to generate")

# Return results
{
    'worm': worm_b64,
    'wheel': wheel_b64,
    'success': worm_b64 is not None and wheel_b64 is not None
}
                `);

                const pythonElapsed = ((Date.now() - pythonStartTime) / 1000).toFixed(1);
                log(`‚úì Python execution completed (${pythonElapsed}s)`, 'success');
                log('', 'info');

                // Process results
                log('‚è≥ Step 4/4: Processing results...', 'info');
                const resultObj = result.toJs({ dict_converter: Object.fromEntries });

                log(`Result status: ${resultObj.success ? 'SUCCESS' : 'FAILED'}`, resultObj.success ? 'success' : 'error');
                log(`Worm data: ${resultObj.worm ? 'Present' : 'Missing'}`, resultObj.worm ? 'success' : 'error');
                log(`Wheel data: ${resultObj.wheel ? 'Present' : 'Missing'}`, resultObj.wheel ? 'success' : 'error');

                if (resultObj.success) {
                    log('', 'info');
                    log('‚úì Geometry generated successfully!', 'success');
                    updateStatus('Generation Complete', 'Downloading STEP files...', 'success');

                    // Create download buttons
                    if (resultObj.worm) {
                        log('üì• Triggering worm.step download...', 'info');
                        downloadSTEP('worm.step', resultObj.worm);
                        log('‚úì Worm STEP file download triggered', 'success');
                    }

                    if (resultObj.wheel) {
                        log('üì• Triggering wheel.step download...', 'info');
                        downloadSTEP('wheel.step', resultObj.wheel);
                        log('‚úì Wheel STEP file download triggered', 'success');
                    }

                    const totalElapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    log('', 'info');
                    log(`‚úÖ Generation complete! Total time: ${totalElapsed}s`, 'success');
                    log('üìÅ Check your downloads folder for worm.step and wheel.step', 'success');
                    updateStatus('Ready', 'Files downloaded successfully', 'success');

                } else {
                    log('', 'info');
                    log('‚ùå Generation failed - check messages above for details', 'error');
                    updateStatus('Generation Failed', 'See console for error details', 'error');
                }

            } catch (error) {
                log('', 'info');
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error('Generation error:', error);

                // Show Python traceback if available
                try {
                    const tb = await pyodide.runPythonAsync('import traceback; traceback.format_exc()');
                    if (tb && tb !== 'NoneType: None\n') {
                        log('Python traceback:', 'error');
                        tb.split('\n').forEach(line => line && log(line, 'error'));
                    }
                } catch (e) {
                    console.error('Could not get Python traceback:', e);
                }

                updateStatus('Generation Error', error.message, 'error');
            }
        }

        // Download STEP file from base64
        function downloadSTEP(filename, base64Data) {
            try {
                log(`  Decoding ${filename}...`, 'info');
                // Decode base64 to binary
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                const sizeKB = (bytes.length / 1024).toFixed(1);
                log(`  File size: ${sizeKB} KB (${bytes.length} bytes)`, 'info');

                // Create blob and download
                log(`  Creating download blob...`, 'info');
                const blob = new Blob([bytes], { type: 'application/step' });
                const url = URL.createObjectURL(blob);

                log(`  Triggering browser download for ${filename}...`, 'info');
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);

                // Click to trigger download
                a.click();

                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    log(`  Download complete: ${filename}`, 'success');
                }, 100);

            } catch (error) {
                log(`‚ùå Download failed for ${filename}: ${error.message}`, 'error');
                console.error('Download error:', error);
            }
        }

        // Initialize on page load
        window.onload = () => {
            initPyodide();
        };
    </script>
</body>
</html>
