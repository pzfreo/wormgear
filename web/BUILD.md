# Web Interface Build Process

## Overview

The web interface needs access to the Python `wormgear` package to generate geometry in the browser using WebAssembly (Pyodide + build123d).

## Build Script

The `build.sh` script copies the Python package from `../src/wormgear/` to `web/src/wormgear/` so it can be fetched by the browser.

### What it does:

1. **Copies package files**:
   - `src/wormgear/` → `web/src/wormgear/`
   - Includes core, io, calculator submodules

2. **Cleans Python artifacts**:
   - Removes `__pycache__` directories
   - Removes `.pyc` files

3. **Verifies structure**:
   - Checks all required files exist
   - Lists copied files for debugging

### Usage:

```bash
# Manual build (for local development)
cd web
./build.sh

# Automatic build (Vercel)
# Runs automatically via vercel.json buildCommand
```

## Vercel Deployment

Vercel automatically runs `build.sh` before deployment via the `buildCommand` in `vercel.json`:

```json
{
  "buildCommand": "cd web && ./build.sh",
  ...
}
```

## Package Loading in Browser

The `app-lazy.js` file loads Python files into Pyodide's filesystem:

1. Fetches files from `src/wormgear/` (HTTP GET)
2. Writes them to Pyodide's virtual filesystem at `/home/pyodide/wormgear/`
3. Adds `/home/pyodide` to Python's `sys.path`
4. Imports: `from wormgear.core import WormGeometry, WheelGeometry`

## Directory Structure

```
web/
├── build.sh              # Build script
├── BUILD.md              # This file
├── index.html            # Web interface
├── app-lazy.js           # Application logic
├── src/                  # Package files (generated by build.sh)
│   └── wormgear/         # Copied from ../src/wormgear/
│       ├── __init__.py
│       ├── core/         # Geometry classes
│       │   ├── __init__.py
│       │   ├── worm.py
│       │   ├── wheel.py
│       │   ├── features.py
│       │   ├── globoid_worm.py
│       │   └── virtual_hobbing.py
│       └── io/           # Parameter classes
│           ├── __init__.py
│           ├── schema.py
│           └── loaders.py
└── wormcalc/             # Calculator module (separate)
```

## Troubleshooting

### "Failed to load wormgear" error

**Cause**: Build script hasn't run, or files missing

**Solution**:
```bash
cd web
./build.sh
```

### Local development

When running locally with `python -m http.server`, the build script must be run manually:

```bash
cd web
./build.sh
python -m http.server 8000
# Open http://localhost:8000
```

### Vercel deployment

Vercel runs `build.sh` automatically. No manual steps needed.

## Why This Approach?

**Problem**: Pyodide runs in browser and can't access server filesystem directly

**Solution**:
1. Copy Python files to web directory (build time)
2. Serve them as static files (HTTP)
3. Fetch and load into Pyodide virtual filesystem (runtime)

**Alternative considered**: Package wormgear as a wheel and install via micropip
- **Rejected**: Adds complexity, requires publishing to PyPI or custom index
- **Current approach**: Simple file copy, works with source code directly
